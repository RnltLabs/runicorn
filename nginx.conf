# ============================================
# Runicorn - Production nginx Configuration
# ============================================
# Project: Runicorn (GPS Art Route Planner)
# Security: OWASP Top 10 compliant
# GDPR: Privacy-conscious headers
# Last Updated: 2025-10-27
# ============================================

server {
    listen 3002;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # Remove server version header (prevent information disclosure)
    # OWASP A05:2021 - Security Misconfiguration
    server_tokens off;

    # ========================================
    # SECURITY HEADERS (OWASP Best Practices)
    # ========================================
    
    # ----------------------------------------
    # Clickjacking Protection
    # ----------------------------------------
    # Prevents Runicorn from being embedded in iframes (phishing protection)
    # OWASP A04:2021 - Insecure Design
    add_header X-Frame-Options "DENY" always;
    
    # ----------------------------------------
    # MIME-Sniffing Protection
    # ----------------------------------------
    # Prevents browsers from interpreting files as different MIME type
    # Example: Prevents .txt file being executed as JavaScript
    # OWASP A05:2021 - Security Misconfiguration
    add_header X-Content-Type-Options "nosniff" always;
    
    # ----------------------------------------
    # XSS Filter (Legacy Browsers)
    # ----------------------------------------
    # Enables browser's built-in XSS filter (older browsers)
    # Modern browsers rely on CSP instead
    # OWASP A03:2021 - Injection
    add_header X-XSS-Protection "1; mode=block" always;
    
    # ----------------------------------------
    # Referrer Policy (Privacy)
    # ----------------------------------------
    # Controls how much referrer information is sent with requests
    # "strict-origin-when-cross-origin" = full URL for same-origin, only origin for cross-origin
    # GDPR Art. 25 - Privacy by Design
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # ----------------------------------------
    # Permissions Policy (Feature Control)
    # ----------------------------------------
    # Disables browser features that Runicorn doesn't need
    # camera=()           - Disable camera access
    # microphone=()       - Disable microphone access  
    # geolocation=(self)  - Allow geolocation ONLY from same origin (required for GPS tracking)
    # payment=()          - Disable Payment Request API
    # usb=()              - Disable WebUSB API
    # interest-cohort=()  - Disable FLoC tracking (privacy)
    # GDPR Art. 25 - Privacy by Design
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=(self), payment=(), usb=(), interest-cohort=()" always;
    
    # ----------------------------------------
    # Content Security Policy (CSP) - CRITICAL!
    # ----------------------------------------
    # Prevents XSS attacks by whitelisting allowed resource sources
    # OWASP A03:2021 - Injection (XSS Prevention)
    #
    # Breakdown:
    # - default-src 'self'                  = Only load resources from runicorn.io by default
    # - script-src 'self' 'unsafe-inline'   = Allow scripts from same origin + inline scripts (Vite build)
    #              https://analytics.rnltlabs.de    (Umami Analytics)
    #              https://errors.rnltlabs.de       (GlitchTip Error Tracking)
    #              https://unpkg.com                (Leaflet library - TODO: self-host)
    # - style-src 'self' 'unsafe-inline'    = Allow styles from same origin + inline styles (Tailwind CSS)
    #             https://fonts.googleapis.com      (Google Fonts CSS)
    #             https://unpkg.com                 (Leaflet CSS - TODO: self-host)
    # - font-src 'self'                     = Allow fonts from same origin
    #            https://fonts.gstatic.com          (Google Fonts files)
    # - img-src 'self' data:                = Allow images from same origin + data URIs
    #           https://*.tile.openstreetmap.org   (OpenStreetMap tiles)
    # - connect-src 'self'                  = Allow API requests to same origin
    #               https://graphhopper.com                   (GraphHopper Routing API)
    #               https://runicorn-api-proxy.*.workers.dev  (GraphHopper proxy - Cloudflare Workers)
    #               https://analytics.rnltlabs.de             (Umami tracking)
    #               https://errors.rnltlabs.de                (GlitchTip error reporting)
    #               https://nominatim.openstreetmap.org       (Geocoding search)
    # - frame-ancestors 'none'              = Prevent embedding in iframes (same as X-Frame-Options)
    # - base-uri 'self'                     = Restrict <base> tag to same origin
    # - form-action 'self'                  = Restrict form submissions to same origin
    # - upgrade-insecure-requests           = Automatically upgrade HTTP to HTTPS (requires HTTPS enabled)
    #
    # Note: 'unsafe-inline' is required for Vite builds and Tailwind CSS
    # Consider using nonce-based CSP for stricter security (requires build-time changes)
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://analytics.rnltlabs.de https://errors.rnltlabs.de https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://*.tile.openstreetmap.org; connect-src 'self' https://graphhopper.com https://runicorn-api-proxy.*.workers.dev https://analytics.rnltlabs.de https://errors.rnltlabs.de https://nominatim.openstreetmap.org; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;" always;
    
    # ----------------------------------------
    # HTTP Strict Transport Security (HSTS)
    # ----------------------------------------
    # Forces browsers to ONLY use HTTPS for 1 year
    # includeSubDomains = Also enforce HTTPS for all subdomains
    # preload = Allow inclusion in browser HSTS preload list
    # OWASP A02:2021 - Cryptographic Failures
    # âœ… HTTPS is configured - HSTS enabled!
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # ========================================
    # SPA ROUTING (React Router)
    # ========================================
    # Fallback to index.html for client-side routing
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ========================================
    # STATIC ASSET CACHING
    # ========================================
    # Cache static assets for 1 year (immutable)
    # Performance optimization for fonts, images, CSS, JS
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        # Re-add security headers (nginx bug: location-level headers override server-level)
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    }
}
